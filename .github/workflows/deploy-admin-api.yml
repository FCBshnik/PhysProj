name: deploy-admin-api

on: workflow_dispatch

jobs:
    deploy:
        runs-on: ubuntu-latest
        env:
            SRV_HOST : ${{vars.SRV_GATEWAY_HOST}}
            SRV_USER : ${{vars.SRV_GATEWAY_USER}}
            SSH_PATH: /home/runner/.ssh
            SSH_AUTH_SOCK: /tmp/ssh_agent.sock
            SRC_PATH: ./src/PhysProj/Phys.Lib.Admin.Api
        strategy:
            matrix:
              dotnet-version: [ '8.x.x' ]
        steps:
        - name: Check out repository
          uses: actions/checkout@v3
        - name: Update appsettings.json
          uses: cschleiden/replace-tokens@v1
          with:
            files: '${{ github.workspace }}/cicd/envs/public/srv-app/admin-api/settings/appsettings.json'
          env:
            MONGO: ${{ secrets.SRV_MONGO_URL }}
        - name: Show appsettings.json
          run: |
            appsettingsJson="$(cat $GITHUB_WORKSPACE/cicd/envs/public/srv-app/admin-api/settings/appsettings.json)"
            echo $appsettingsJson
        - name: Setup dotnet ${{ matrix.dotnet-version }}
          uses: actions/setup-dotnet@v3
          with:
            dotnet-version: ${{ matrix.dotnet-version }}
        - name: Dotnet app build
          run: |
            version=`date -u +%Y.%m.%d.%H%M`
            dotnet publish --output $GITHUB_WORKSPACE/cicd/envs/public/srv-app/admin-api/bin /p:Version=$version
          working-directory: ${{ env.SRC_PATH }}
        - name: Init SSH agent
          run: |
            mkdir -p $SSH_PATH
            ssh-keyscan $SRV_HOST >> $SSH_PATH/known_hosts
            echo "${{ secrets.SRV_GATEWAY_SSH_PRIVATE_KEY }}" > $SSH_PATH/ssh_key
            chmod 600 $SSH_PATH/ssh_key
            ssh-agent -a $SSH_AUTH_SOCK > /dev/null
            ssh-add $SSH_PATH/ssh_key
        - name: Create docker context
          run: docker context create physproj --docker "host=ssh://$SRV_USER@$SRV_HOST"
        - name: Build and deploy docker image
          run: bash ./admin-api/deploy.sh
          working-directory: ${{ github.workspace }}/cicd/envs/public/srv-app/